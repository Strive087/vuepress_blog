# TCP协议

## tcp连接的特点

- 提供面向连接的，可靠的字节流服务
- 为上层应用层提供服务，不关心具体传输的内容是什么，也不知道是二进制流，还是ascii字符。

## tcp的可靠性如何保证

1. 分块传送：数据被分割成最合适的数据块（UDP的数据报长度不变）
2. 等待确认：通过定时器等待接收端发送确认请求，收不到确认则重发
3. 确认回复：收到确认后发送确认回复(不是立即发送，通常推迟几分之一秒)
4. 数据校验：保持首部和数据的校验和，检测数据传输过程有无变化
5. 乱序排序：接收端能重排序数据，以正确的顺序交给应用端
6. 重复丢弃：接收端能丢弃重复的数据包
7. 流量缓冲：两端有固定大小的缓冲区（滑动窗口），防止速度不匹配丢数据

## tcp的首部格式

![1660a9b6dee9caf5](https://zhuduanlei-1256381138.cos.ap-guangzhou.myqcloud.com/uPic/1660a9b6dee9caf5.jpg)

从应用层->传输层->网络层->链路层，每经过一次都会在报文中增加相应的首部。TCP数据被封装在IP数据报中。

![1660aa15acdcc530](https://zhuduanlei-1256381138.cos.ap-guangzhou.myqcloud.com/uPic/1660aa15acdcc530.jpg)

- 第5-8四个字节：32位序号。tcp提供全双工服务，两端都有各自的序号。编号：解决网络包乱序的问题
- 第9-12四个字节：32位确认序列号。上次成功收到数据字节序号加1，ack为1才有效。确认号：解决丢包的问题
- 第15-16两个字节：窗口大小。接收端期望接收的字节数。解决流量控制的问题
- 第17-18两个字节：校验和。由发送端计算和存储，由接收端校验。解决数据正确性问题

### 标识位说明

- URG：为1时，表示紧急指针有效
- ACK：确认标识，连接建立成功后，总为1。为1时确认号有效
- PSH：接收方应尽快把这个报文交给应用层
- RST：复位标识，重建连接
- SYN：建立新连接时，该位为0
- FIN：关闭连接标识
